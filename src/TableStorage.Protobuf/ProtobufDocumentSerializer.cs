//<auto-generated/>
#nullable enable
using System;
using System.IO;
using ProtoBuf;
using ProtoBuf.Meta;

namespace Devlooped
{
    /// <summary>
    /// Default implementation of <see cref="IBinaryDocumentSerializer"/> which 
    /// uses Newtonsoft.Json implementation of BSON for serialization.
    /// </summary>
    partial class ProtobufDocumentSerializer : IBinaryDocumentSerializer
    {
        /// <summary>
        /// Default instance of the serializer.
        /// </summary>
        public static IDocumentSerializer Default { get; } = new ProtobufDocumentSerializer();

#if NET6_0_OR_GREATER
        static ProtobufDocumentSerializer()
        {
            RuntimeTypeModel.Default.SetSurrogate<DateOnly, int>(
                UnderlyingToSurrogate, 
                SurrogateToUnderlying);
        }

        static int UnderlyingToSurrogate(DateOnly value) => value.DayNumber;
        static DateOnly SurrogateToUnderlying(int value) => DateOnly.FromDayNumber(value);
#endif

        /// <inheritdoc />
        public T? Deserialize<T>(byte[] data)
        {
            if (data.Length == 0)
                return default;

            using var mem = new MemoryStream(data);
            return (T?)Serializer.Deserialize(typeof(T), mem);
        }

        /// <inheritdoc />
        public byte[] Serialize<T>(T value)
        {
            if (value == null)
                return new byte[0];

            using var mem = new MemoryStream();
            Serializer.Serialize(mem, value);
            return mem.ToArray();
        }
    }
}
